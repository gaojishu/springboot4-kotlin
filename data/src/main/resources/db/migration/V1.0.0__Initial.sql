-- 1. ç¡®ä¿ Schema å­˜åœ¨
CREATE SCHEMA IF NOT EXISTS "admin";

-- ç®¡ç†å‘˜è¡¨
CREATE TABLE IF NOT EXISTS "admin"."admin" (
    "created_at"      timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"      timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deleted_at"      timestamp(6),
    "id"              int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "username"        varchar(55) NOT NULL,
    "password"        varchar(100) NOT NULL,
    "nickname"        varchar(55),
    "email"           varchar(55),
    "mobile"          varchar(20),
    "permission_key"  json,
    "disabled_status" int2 NOT NULL DEFAULT 0
    );

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX IF NOT EXISTS "uk_username" ON "admin"."admin" ("username");

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO "admin"."admin" ("id", "username", "password")
VALUES (1, 'admin123', '$2a$10$uMJY137kuoJWqa.yEBpU6OE5Yh1lYNtnJPOlewFpnE81rd7C3qlsm');

-- åŒæ­¥ ID åºåˆ— (é˜²æ­¢è‡ªåŠ¨å¢é•¿å†²çª)
SELECT setval(pg_get_serial_sequence('"admin"."admin"', 'id'), MAX(id)) FROM "admin"."admin";

-- åˆ›å»ºæƒé™è¡¨
CREATE TABLE IF NOT EXISTS "admin"."permission" (
    "id"          int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "parent_id"   int8,
    "name"        varchar(55)  NOT NULL,
    "code"        varchar(100),
    "key"         varchar(100) NOT NULL DEFAULT '',
    "type"        int2         NOT NULL DEFAULT 1,
    "level"       int4         NOT NULL,
    "path"        varchar(100),
    "icon"        varchar(100),
    "sort"        int4         NOT NULL DEFAULT 1000,
    "remark"      varchar(100),
    "created_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- ğŸ’¡ æ ‘å½¢ç»“æ„å¿…å¤‡ç´¢å¼•ï¼šåŠ é€Ÿçˆ¶å­èŠ‚ç‚¹æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS "idx_permission_parent_id" ON "admin"."permission" ("parent_id");
-- ğŸ’¡ å”¯ä¸€æ€§ç´¢å¼•ï¼šç¡®ä¿æƒé™æ ‡è¯†ç¬¦ä¸é‡å¤
CREATE UNIQUE INDEX IF NOT EXISTS "uk_permission_key" ON "admin"."permission" ("key");

-- æ’å…¥åˆå§‹æƒé™æ•°æ® (å»æ‰æ—¶é—´ï¼Œç”±æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ)
INSERT INTO "admin"."permission"
("id", "parent_id", "name", "code", "key", "type", "level", "path", "sort")
VALUES
    (1,  NULL, 'ç³»ç»Ÿ',       NULL, '1',        1, 1, NULL, 1),
    (2,  1,    'æƒé™ç®¡ç†',   NULL, '1-2',      1, 2, '/admin/permission', 2),
    (12, 1,    'æƒé™æ¨¡æ¿',   NULL, '1-12',     1, 2, '/admin/role', 3),
    (13, 1,    'ç®¡ç†å‘˜',     NULL, '1-13',     1, 2, '/admin/admin', 1),
    (14, 1,    'æ“ä½œæ—¥å¿—',   NULL, '1-14',     1, 2, '/admin/opLog', 4),
    (15, 13,   'ç®¡ç†å‘˜æŸ¥è¯¢', 'admin:read', '1-13-15', 2, 3, NULL, 1),
    (16, 13,   'ç®¡ç†å‘˜åˆ›å»º', 'admin:create', '1-13-16', 2, 3, NULL, 1),
    (17, 13,   'ç®¡ç†å‘˜æ›´æ–°', 'admin:update', '1-13-17', 2, 3, NULL, 1),
    (18, 2,    'æƒé™æŸ¥è¯¢',   'permission:read', '1-2-18', 2, 3, NULL, 1),
    (19, 2,    'æƒé™åˆ›å»º',   'permission:create', '1-2-19', 2, 3, NULL, 1),
    (20, 2,    'æƒé™æ›´æ–°',   'permission:update', '1-2-20', 2, 3, NULL, 1),
    (21, 2,    'æƒé™åˆ é™¤',   'permission:delete', '1-2-21', 2, 3, NULL, 1),
    (22, 12,   'æƒé™æ¨¡æ¿æŸ¥è¯¢', 'role:read', '1-12-22', 2, 3, NULL, 1),
    (23, 12,   'æƒé™æ¨¡æ¿åˆ›å»º', 'role:create', '1-12-23', 2, 3, NULL, 1),
    (24, 12,   'æƒé™æ¨¡æ¿æ›´æ–°', 'role:update', '1-12-24', 2, 3, NULL, 1),
    (25, 12,   'æƒé™æ¨¡æ¿åˆ é™¤', 'role:delete', '1-12-25', 2, 3, NULL, 1),
    (26, 14,   'æ“ä½œæ—¥å¿—æŸ¥è¯¢', 'op_log:read', '1-14-26', 2, 3, NULL, 1),
    (27, 14,   'æ“ä½œæ—¥å¿—å¯¼å‡º', 'op_log:export', '1-14-27', 2, 3, NULL, 1),
    (28, NULL, 'æ–‡ä»¶ç®¡ç†å…¨éƒ¨æƒé™', 'file:all', '28', 2, 1, NULL, 1),
    (29, 1,    'ä»»åŠ¡ç®¡ç†',   NULL, '1-29',     1, 2, '/admin/asyncJob', 11),
    (30, 29,   'ä»»åŠ¡æŸ¥è¯¢',   'batch_job:read', '1-29-30', 2, 3, NULL, 1)
;

SELECT setval(pg_get_serial_sequence('"admin"."permission"', 'id'), MAX(id)) FROM "admin"."permission";

-- ç®¡ç†å‘˜ - æƒé™å…³è”è¡¨
CREATE TABLE "admin"."admin_permission" (
    "admin_id" int8 NOT NULL,
    "permission_id" int8 NOT NULL
);

-- æƒé™æ¨¡æ¿è¡¨
CREATE TABLE IF NOT EXISTS "admin"."role" (
    "id"             int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name"           varchar(55)  NOT NULL DEFAULT '',
    "permission_key" json,
    "remark"         varchar(100),
    "created_at"     timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"     timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- æ–‡ä»¶è¡¨
CREATE TABLE IF NOT EXISTS "admin"."files" (
    "id"          int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "category_id" int8,
    "name"        varchar(100) NOT NULL DEFAULT '',
    "key"         varchar(100) NOT NULL DEFAULT '',
    "hash"        varchar(100) NOT NULL DEFAULT '',
    "type"        varchar(50)  NOT NULL DEFAULT '',
    "mime_type"   varchar(100),
    "size"        int8         NOT NULL DEFAULT 0,
    "remark"      varchar(100),
    "created_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- å»ºè®®ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•ï¼ˆå¯é€‰ï¼‰
CREATE INDEX IF NOT EXISTS "idx_files_key" ON "admin"."files" ("key");
CREATE INDEX IF NOT EXISTS "idx_files_hash" ON "admin"."files" ("hash");

-- åˆ›å»ºæ–‡ä»¶åˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS "admin"."files_category" (
    "id"          int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name"        varchar(55)  NOT NULL DEFAULT '',
    "remark"      varchar(100),
    "created_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- åˆ›å»ºæ¶ˆæ¯è¡¨
CREATE TABLE IF NOT EXISTS "admin"."notice" (
    "id"          int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "admin_id"    int8,
    "title"       varchar(100) NOT NULL,
    "content"     varchar(200) NOT NULL,
    "attachments" json,
    "created_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"  timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- å»ºè®®ï¼šä¸ºå‘å¸ƒäººæ·»åŠ ç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥è¯¢æŸä¸ªç®¡ç†å‘˜å‘å¸ƒçš„å…¬å‘Š
CREATE INDEX IF NOT EXISTS "idx_notice_admin_id" ON "admin"."notice" ("admin_id");

-- åˆ›å»ºæ“ä½œæ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS "admin"."op_log" (
    "id"           int8 NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "admin_id"     int8,
    "ip"           varchar(100) NOT NULL,
    "method"       varchar(22)  NOT NULL,
    "uri"          varchar(100),
    "params"       text,
    "query_params" text,
    "duration"     int8         NOT NULL,
    "remark"       varchar(100),
    "created_at"   timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at"   timestamp(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

-- ğŸ’¡ æ€§èƒ½å»ºè®®ï¼šç”±äºæ—¥å¿—è¡¨æŸ¥è¯¢é¢‘ç¹ï¼Œå»ºè®®æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS "idx_op_log_admin_id" ON "admin"."op_log" ("admin_id");
CREATE INDEX IF NOT EXISTS "idx_op_log_created_at" ON "admin"."op_log" ("created_at");


